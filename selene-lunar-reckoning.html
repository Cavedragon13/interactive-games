<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moon Survival Game</title>
    <meta name="robots" content="noindex, nofollow">
    <meta name="author" content="Your Name/Organization">
    <meta name="description" content="Educational lunar survival game for learning about space exploration priorities">
    <style>
        /* NASA-themed colors */
        :root {
            --nasa-blue-dark: #003366; /* Deep Navy */
            --nasa-blue-medium: #0A2351; /* Darker Blue */
            --nasa-red-accent: #FC3D21; /* Vibrant Red */
            --nasa-orange-accent: #FF6B35; /* Orange for gradients */
            --nasa-white: #FFFFFF;
            --nasa-light-grey: #E0E0E0;
            --nasa-medium-grey: #A8B2D1;
            --nasa-dark-grey: #444;
            --nasa-light-blue: #5A9FD4;
        }

        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--nasa-blue-dark) 0%, var(--nasa-blue-medium) 50%, var(--nasa-blue-dark) 100%);
            color: var(--nasa-white);
            min-height: 10vh;
            padding: 20px;
            line-height: 1.6;
            overflow-y: auto;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.6); /* Slightly transparent black for contrast */
            border: 3px solid var(--nasa-red-accent);
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(252, 61, 33, 0.2), inset 0 0 20px rgba(255, 255, 255, 0.05);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(90deg, var(--nasa-blue-dark) 0%, var(--nasa-blue-medium) 50%, var(--nasa-blue-dark) 100%);
            padding: 25px;
            text-align: center;
            border-bottom: 3px solid var(--nasa-red-accent);
            position: relative;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--nasa-red-accent) 0%, var(--nasa-orange-accent) 50%, var(--nasa-red-accent) 100%);
        }
        .title {
            font-family: 'Inter', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--nasa-white);
            text-shadow: 0 0 15px rgba(252, 61, 33, 0.6);
            margin-bottom: 8px;
            letter-spacing: 2px;
        }
        .nasa-logo {
            display: inline-block;
            background: var(--nasa-red-accent);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        .subtitle {
            font-size: 16px;
            color: var(--nasa-medium-grey);
            opacity: 0.9;
            font-weight: 500;
        }
        .game-content {
            padding: 30px;
        }
        .scenario-box {
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.8) 0%, rgba(10, 35, 81, 0.6) 100%); /* Using NASA blues */
            border: 2px solid var(--nasa-light-blue);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: inset 0 0 15px rgba(90, 159, 212, 0.1);
            position: relative;
        }
        .scenario-box::before {
            content: 'MISSION BRIEFING';
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--nasa-blue-dark);
            color: var(--nasa-light-blue);
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .scenario-title {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--nasa-red-accent);
            margin-bottom: 18px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .scenario-text {
            font-size: 14px;
            line-height: 1.8;
            text-align: justify;
        }
        .instructions {
            background: linear-gradient(135deg, rgba(252, 61, 33, 0.15) 0%, rgba(255, 107, 53, 0.1) 100%);
            border: 2px solid var(--nasa-red-accent);
            border-radius: 8px;
            padding: 18px;
            margin: 20px 0;
            font-size: 14px;
            font-weight: 500;
            position: relative;
        }
        .instructions::before {
            content: 'MISSION PARAMETERS';
            position: absolute;
            top: -12px;
            left: 15px;
            background: var(--nasa-blue-dark);
            color: var(--nasa-red-accent);
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .drag-instructions {
            background: linear-gradient(135deg, rgba(90, 159, 212, 0.15) 0%, rgba(168, 178, 209, 0.1) 100%);
            border: 2px solid var(--nasa-light-blue);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        .ranking-area {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin: 20px 0;
            min-height: 400px;
        }
        .item-card {
            background: linear-gradient(135deg, rgba(10, 35, 81, 0.9) 0%, rgba(0, 51, 102, 0.8) 100%); /* NASA blues */
            border: 2px solid var(--nasa-medium-grey);
            border-radius: 10px;
            padding: 18px;
            transition: all 0.3s ease;
            position: relative;
            cursor: grab;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .item-card:hover {
            border-color: var(--nasa-light-blue);
            box-shadow: 0 4px 20px rgba(90, 159, 212, 0.3);
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(90, 159, 212, 0.2) 0%, rgba(10, 35, 81, 0.9) 100%);
        }
        .item-card.dragging {
            opacity: 0.7;
            transform: rotate(3deg);
            cursor: grabbing;
            z-index: 1000;
            box-shadow: 0 15px 35px rgba(252, 61, 33, 0.4);
            border-color: var(--nasa-red-accent);
        }
        .item-card.drag-over {
            border-color: var(--nasa-red-accent);
            background: linear-gradient(135deg, rgba(252, 61, 33, 0.2) 0%, rgba(10, 35, 81, 0.9) 100%);
        }
        .rank-number {
            background: linear-gradient(45deg, var(--nasa-red-accent), var(--nasa-orange-accent));
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(252, 61, 33, 0.3);
        }
        .item-content {
            flex: 1;
        }
        .item-name {
            font-weight: 600;
            color: var(--nasa-white);
            margin-bottom: 6px;
            font-size: 15px;
        }
        .item-description {
            font-size: 13px;
            color: var(--nasa-medium-grey);
            font-style: italic;
            margin-bottom: 0;
        }
        .drag-handle {
            background: rgba(255, 255, 255, 0.1);
            color: var(--nasa-light-grey);
            font-size: 28px; /* Larger */
            font-weight: 900; /* Bolder */
            cursor: grab;
            padding: 8px 12px; /* More padding */
            border-radius: 8px; /* More rounded */
            transition: all 0.2s ease;
            opacity: 0.8;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.1);
            line-height: 1; /* Adjust line height */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .drag-handle:hover {
            color: var(--nasa-white);
            background: var(--nasa-light-blue);
            opacity: 1;
            box-shadow: 0 0 15px var(--nasa-light-blue);
        }
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        .btn {
            background: linear-gradient(45deg, var(--nasa-red-accent), var(--nasa-orange-accent));
            border: none;
            color: white;
            padding: 15px 30px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(252, 61, 33, 0.3);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(252, 61, 33, 0.5);
            background: linear-gradient(45deg, var(--nasa-orange-accent), var(--nasa-red-accent));
        }
        .btn:disabled {
            background: var(--nasa-dark-grey);
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .results {
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.9) 0%, rgba(10, 35, 81, 0.8) 100%);
            border: 2px solid var(--nasa-light-blue);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            display: none;
            box-shadow: 0 5px 20px rgba(90, 159, 212, 0.2);
        }
        .results.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .score {
            font-family: 'Inter', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--nasa-white);
            text-align: center;
            margin-bottom: 25px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid var(--nasa-dark-grey);
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background: rgba(90, 159, 212, 0.3);
            color: var(--nasa-white);
            font-weight: 600;
        }
        .comparison-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }
        .expert-explanation {
            background: linear-gradient(135deg, rgba(90, 159, 212, 0.15) 0%, rgba(168, 178, 209, 0.1) 100%);
            border-left: 4px solid var(--nasa-light-blue);
            padding: 18px;
            margin: 15px 0;
            font-size: 13px;
            border-radius: 0 8px 8px 0;
        }
        .progress-indicator {
            text-align: center;
            font-size: 15px;
            margin: 20px 0;
            color: var(--nasa-light-blue);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
        }
        .disclaimer, .privacy-notice, .age-notice, .language-notice, .contact-info {
            font-size: 10px;
            color: #777;
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed #333;
        }
        .privacy-notice, .age-notice, .language-notice, .contact-info {
            font-size: 11px;
            color: #888;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border-top: none; /* Remove duplicate border */
            padding-top: 15px; /* Adjust padding */
        }
        .cookie-notice {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--nasa-blue-medium);
            color: white;
            padding: 15px;
            text-align: center;
            border-top: 2px solid var(--nasa-red-accent);
            z-index: 9999;
            display: none; /* Hidden by default, shown by JS if needed */
        }

        .cookie-notice button {
            background: var(--nasa-red-accent);
            color: white;
            border: none;
            padding: 5px 15px;
            margin-left: 15px;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Difficulty and Timer styles */
        .difficulty-selection {
            text-align: center;
            margin-bottom: 20px;
        }
        .difficulty-selection button {
            background: var(--nasa-blue-medium);
            border: 1px solid var(--nasa-light-blue);
            color: var(--nasa-white);
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .difficulty-selection button:hover,
        .difficulty-selection button.active {
            background: var(--nasa-light-blue);
            box-shadow: 0 0 10px var(--nasa-light-blue);
        }
        .timer-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 48px;
            font-weight: 700;
            color: var(--nasa-red-accent);
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(252, 61, 33, 0.5);
        }

        /* High Score List */
        .high-scores {
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.9) 0%, rgba(10, 35, 81, 0.8) 100%);
            border: 2px solid var(--nasa-light-blue);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 5px 20px rgba(90, 159, 212, 0.2);
            display: none; /* Hidden by default */
        }
        .high-scores.show {
            display: block;
        }
        .high-scores h3 {
            text-align: center;
            color: var(--nasa-white);
            margin-bottom: 15px;
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
        }
        .high-scores ol {
            list-style: none;
            padding: 0;
            max-width: 300px;
            margin: 0 auto;
        }
        .high-scores li {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            color: var(--nasa-light-grey);
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }
        .high-scores li:last-child {
            border-bottom: none;
        }
        .high-scores li span:first-child {
            color: var(--nasa-red-accent);
            font-weight: bold;
        }
        .high-scores li span:last-child {
            color: var(--nasa-white);
        }

        /* Initials input modal */
        .initials-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            display: none;
        }
        .initials-modal-content {
            background: var(--nasa-blue-medium);
            border: 2px solid var(--nasa-red-accent);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 0 20px rgba(252, 61, 33, 0.5);
        }
        .initials-modal-content h4 {
            color: var(--nasa-white);
            font-size: 24px;
            margin-bottom: 20px;
        }
        .initials-modal-content input {
            width: 120px;
            padding: 10px;
            font-size: 24px;
            text-align: center;
            text-transform: uppercase;
            background: var(--nasa-blue-dark);
            border: 1px solid var(--nasa-light-blue);
            color: var(--nasa-white);
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: 'Space Mono', monospace;
        }
        .initials-modal-content button {
            background: var(--nasa-red-accent);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 20px;
            }
            .game-content {
                padding: 15px;
            }
            .item-card {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            .rank-number {
                margin-bottom: 10px;
            }
            .difficulty-selection button {
                display: block;
                width: 80%;
                margin: 10px auto;
            }
            .timer-display {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nasa-logo">NASA</div>
            <div class="title">LUNAR SURVIVAL MISSION</div>
            <div class="subtitle">Astronaut Training Exercise • Mission Control Interface</div>
        </div>
        <div class="game-content">
            <div class="scenario-box">
                <div class="scenario-title">⚠️ EMERGENCY SITUATION ⚠️</div>
                <div class="scenario-text">
                    The year is 2025. You are part of a four-member crew traveling to the Moon in your spacecraft.
                    As you prepare to land at the lunar outpost near the south pole, disaster strikes!
                    A thruster malfunction forces an emergency landing <strong>80 kilometers (50 miles)</strong> from your destination.
                    <br><br>
                    You find yourself stranded on the charcoal-gray, dusty surface of the Moon. The environment is harsh and unforgiving:
                    no atmosphere, deadly radiation, temperatures ranging from -193°C (-315°F) at night to 111°C (232°F) during the day,
                    and gravity only one-sixth that of Earth.
                    <br><br>
                    <strong>Your survival depends on reaching the lunar outpost.</strong> You must choose the most critical items
                    from your damaged spacecraft to make the treacherous journey across the lunar landscape.
                </div>
            </div>
            <div class="instructions">
                <strong>MISSION INSTRUCTIONS:</strong><br>
                Rank the 15 items below from 1 (most important) to 15 (least important) for your survival.
                Consider what you need to survive in the lunar environment and reach the outpost 50 miles away.
            </div>
            <div class="difficulty-selection">
                <button id="difficultyUntimed" class="active">Untimed</button>
                <button id="difficulty1min">1 Minute</button>
                <button id="difficulty3min">3 Minutes</button>
                <button id="difficulty5min">5 Minutes</button>
            </div>
            <div class="timer-display" id="timerDisplay">00:00</div>
            <div class="drag-instructions">
                <strong>🖱️ DRAG & DROP:</strong> Drag items up and down to reorder them by importance.
                Trust your instincts and survival logic!
            </div>
            <div class="progress-indicator" id="progressText">
                Arrange all 15 items in order of importance for survival - Ready to analyze!
            </div>
            <div class="ranking-area" id="rankingArea">
                <!-- Items will be populated by JavaScript -->
            </div>
            <div class="controls">
                <button class="btn" onclick="checkRankings()" id="checkBtn">
                    Analyze Survival Strategy
                </button>
                <button class="btn" onclick="resetGame()">Reset Mission</button>
            </div>
            <div class="results" id="results">
                <!-- Results will be populated by JavaScript -->
            </div>

            <div class="high-scores" id="highScoresContainer">
                <h3 id="highScoreTitle">Best Times</h3>
                <ol id="highScoreList"></ol>
            </div>

            <div class="disclaimer">
                <p><strong>Legal Notice:</strong></p>
                <p>This "Lunar Survival Mission" game is a fictional educational exercise designed for entertainment and educational purposes only. It is not affiliated with, endorsed by, or sponsored by NASA, ESA (European Space Agency), or any governmental space agency.</p>
                
                <p><strong>Educational Content:</strong> All scenarios, rankings, and explanations are based on publicly available information and general survival principles. This is not professional survival training or official space agency guidance.</p>
                
                <p><strong>Limitation of Liability:</strong> In accordance with EU law, except for liability arising from intent or gross negligence, we exclude all liability for damages arising from the use of this game. This limitation does not apply to damages resulting from injury to life, body, or health.</p>
                
                <p><strong>Intellectual Property:</strong> NASA is a trademark of the U.S. Government. This game constitutes fair use for educational purposes under applicable law.</p>
                
                <p><strong>Accessibility:</strong> We strive to make this content accessible. If you encounter accessibility issues, please contact [accessibility contact].</p>
                
                <p><strong>Applicable Law:</strong> If you are accessing this game from the European Union, the laws of your country of residence within the European Union apply to these terms, without regard to conflict of law provisions.</p>
            </div>
            <div class="privacy-notice">
                <p><strong>Privacy Notice:</strong> This game does not collect, store, or process any personal data. It runs entirely in your browser with no server communication. No cookies or tracking technologies are used.</p>
            </div>
            <div class="age-notice">
                <p><strong>Age Guidance:</strong> This educational game is suitable for ages 12 and above.</p>
            </div>
            <div class="language-notice">
                <p>This game is currently available in English only. / Ce jeu n'est actuellement disponible qu'en anglais. / Dieses Spiel ist derzeit nur auf Englisch verfügbar.</p>
            </div>
            <div class="contact-info">
                <p><strong>Contact:</strong> For questions about this educational game, please contact: [your-email@example.com]</p>
                <p><strong>Responsible Party:</strong> [Your Name or Organization Name], [Your Address/City, Country]</p>
            </div>
        </div>
    </div>

    <div class="cookie-notice" id="cookieNotice">
        <p>This website does not use cookies or tracking technologies. 
        <button onclick="document.getElementById('cookieNotice').style.display='none'">OK</button></p>
    </div>

    <div class="initials-modal" id="initialsModal">
        <div class="initials-modal-content">
            <h4>Enter Your Initials</h4>
            <input type="text" id="initialsInput" maxlength="3" pattern="[A-Z]{3}" title="Three uppercase letters" oninput="this.value = this.value.toUpperCase()">
            <button onclick="submitInitials()">Submit</button>
        </div>
    </div>

    <script>
        const items = [
            { id: 'oxygen', name: "Two 45.5kg (100-pound) tanks of oxygen", description: "Pressurized tanks of oxygen", expertRank: 1, explanation: "With basically no atmosphere on the Moon, oxygen to breathe is the most pressing survival need. The average person needs about 0.84 kilograms of O2 per day." },
            { id: 'water', name: "38 liters (10 gallons) of water", description: "Container of water", expertRank: 2, explanation: "Water is essential to all life. There is no liquid water on the Moon, and each astronaut needs about 11 liters of water daily." },
            { id: 'food', name: "Food concentrate", description: "Dehydrated food to which water is added", expertRank: 3, explanation: "Food concentrate is a good source of nutrition and an efficient way to carry it. Though it needs water, it meets a basic survival need." },
            { id: 'radio', name: "Solar-powered radio receiver-transmitter", description: "Communication tool powered by the sun", expertRank: 4, explanation: "Maintaining communication with the lunar outpost is essential. People there are looking for you while you try to reach them." },
            { id: 'firstaid', name: "First aid kit", description: "Basic first aid kit with pain medication and medicine for infection", expertRank: 5, explanation: "A first aid kit takes up little space and may be important in case of illness or injury during the journey." },
            { id: 'map', name: "Map of the Moon's surface", description: "A map showing the Moon's terrain", expertRank: 6, explanation: "With no other directional tools available, a map is the most important means of finding your way from one location to another." },
            { id: 'repair', name: "Space suit repair kit", description: "Materials to repair tiny holes in fabric", expertRank: 7, explanation: "Your space suit protects you from harsh conditions. The sharp lunar soil can cut tiny holes that may compromise its effectiveness." },
            { id: 'raft', name: "Life raft", description: "Self-inflatable floatation device", expertRank: 8, explanation: "The life raft makes a great sled for carrying the oxygen and water across the lunar surface." },
            { id: 'blanket', name: "Space blanket", description: "Thin sheet of plastic material coated with metallic reflecting layer", expertRank: 9, explanation: "Used to insulate supplies from extreme temperatures. Temperatures can range from -193°C to 111°C on the Moon." },
            { id: 'rope', name: "15 meters (50 feet) of nylon rope", description: "Manufactured rope", expertRank: 10, explanation: "The rope makes dragging the life raft easier or may come in handy when crossing difficult terrain." },
            { id: 'lights', name: "Lights with solar-powered rechargeable batteries", description: "Portable lights powered by solar batteries", expertRank: 11, explanation: "The lights are helpful if you travel across large shadowed areas. Some polar regions are permanently dark." },
            { id: 'mirror', name: "Signal mirror", description: "Handheld mirror", expertRank: 12, explanation: "The signal mirror is used as a form of communication if the radio is not working." },
            { id: 'parachute', name: "Parachute", description: "Large piece of silk cloth", expertRank: 13, explanation: "Parachute silk comes in handy as a backup sled to the life raft, or as shade." },
            { id: 'matches', name: "Box of matches", description: "Wooden sticks with sulfur-treated heads", expertRank: 14, explanation: "With little oxygen on the Moon, the matches are useless for starting fires." },
            { id: 'compass', name: "Magnetic compass", description: "Tool that uses a magnetic field to determine direction", expertRank: 15, explanation: "The compass is virtually useless because there is no Moon-wide magnetic field." }
        ];

        let currentOrder = [];
        let draggedElement = null; // Stores the DOM element being dragged
        let dragOverElement = null; // Stores the DOM element currently being dragged over

        // Constants for scoring thresholds
        const SCORE_EXCELLENT = 25;
        const SCORE_GOOD = 45;
        const SCORE_FAIR = 70;

        // Game State Variables
        let gameMode = 'untimed'; // 'untimed', '1min', '3min', '5min'
        let timeRemaining = 0; // in milliseconds
        let timerInterval = null;
        let gameActive = false; // To prevent actions when game is over or timer runs out
        let startTime = 0; // To record start time for accurate time taken calculation

        // High Scores
        const HIGH_SCORES_KEY = 'moonSurvivalHighScores';
        let highScores = {
            '1min': [],
            '3min': [],
            '5min': []
        };

        // Get DOM elements (with basic checks)
        const rankingArea = document.getElementById('rankingArea');
        const resultsDiv = document.getElementById('results');
        const checkBtn = document.getElementById('checkBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        const difficultyButtons = document.querySelectorAll('.difficulty-selection button');
        const initialsModal = document.getElementById('initialsModal');
        const initialsInput = document.getElementById('initialsInput');
        const highScoresContainer = document.getElementById('highScoresContainer');
        const highScoreTitle = document.getElementById('highScoreTitle');
        const highScoreList = document.getElementById('highScoreList');
        const cookieNotice = document.getElementById('cookieNotice');

        // --- Initialization ---
        function initGame() {
            // Load high scores from localStorage
            loadHighScores();

            // Reset game state
            gameActive = true;
            stopTimer(); // Ensure any previous timer is stopped
            timeRemaining = 0; // Reset timer display
            updateTimerDisplay();
            
            // Shuffle items for initial display
            currentOrder = [...items].sort(() => Math.random() - 0.5);
            renderItems();

            // Attach event listeners to the parent rankingArea for delegation
            if (rankingArea) {
                // Remove previous to avoid duplicates when initGame is called multiple times (e.g., on reset)
                rankingArea.removeEventListener('dragstart', handleDragStart); 
                rankingArea.removeEventListener('dragover', handleDragOver);
                rankingArea.removeEventListener('drop', handleDrop);
                rankingArea.removeEventListener('dragend', handleDragEnd);
                rankingArea.removeEventListener('keydown', handleKeyboardDrag); 

                rankingArea.addEventListener('dragstart', handleDragStart);
                rankingArea.addEventListener('dragover', handleDragOver);
                rankingArea.addEventListener('drop', handleDrop);
                rankingArea.addEventListener('dragend', handleDragEnd);
                rankingArea.addEventListener('keydown', handleKeyboardDrag);
            } else {
                console.error("Error: Ranking area not found. Cannot initialize game.");
            }

            // Hide results and high scores on reset
            if (resultsDiv) {
                resultsDiv.classList.remove('show');
                resultsDiv.innerHTML = '';
            }
            if (highScoresContainer) {
                highScoresContainer.classList.remove('show');
            }

            // Set default difficulty to untimed and activate its button
            setDifficulty('untimed');
            checkBtn.disabled = false; // Ensure check button is enabled
        }

        // --- Render Functions ---
        function renderItems() {
            if (!rankingArea) return;

            rankingArea.innerHTML = ''; // Clear existing items
            currentOrder.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.draggable = true; // Make the card draggable
                card.dataset.itemId = item.id; // Store item ID for identification
                card.setAttribute('tabindex', '0'); // Make cards focusable for keyboard navigation
                card.setAttribute('role', 'listitem');
                card.setAttribute('aria-label', `Item ${index + 1}: ${item.name}. ${item.description}. Drag or use arrow keys to reorder.`);

                card.innerHTML = `
                    <div class="rank-number">${index + 1}</div>
                    <div class="item-content">
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                    </div>
                    <div class="drag-handle" aria-hidden="true">☰</div> <!-- Themed grab handle -->
                `;
                rankingArea.appendChild(card);
            });
        }

        // --- Drag and Drop Handlers (Event Delegation) ---
        function handleDragStart(e) {
            if (!gameActive) {
                e.preventDefault();
                return;
            }
            const card = e.target.closest('.item-card');
            if (!card) return; // Ensure we are dragging an item card

            draggedElement = card;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', card.dataset.itemId);

            setTimeout(() => {
                card.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            document.querySelectorAll('.item-card.drag-over').forEach(card => {
                card.classList.remove('drag-over');
            });
            draggedElement = null;
            dragOverElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            if (!gameActive) return;

            const targetCard = e.target.closest('.item-card');

            if (targetCard && targetCard !== draggedElement) {
                if (dragOverElement && dragOverElement !== targetCard) {
                    dragOverElement.classList.remove('drag-over');
                }
                targetCard.classList.add('drag-over');
                dragOverElement = targetCard;
            } else if (!targetCard && dragOverElement) {
                dragOverElement.classList.remove('drag-over');
                dragOverElement = null;
            }
        }

        function handleDrop(e) {
            e.preventDefault(); // Prevent default browser drop behavior
            if (!gameActive) return;

            const dropTargetCard = e.target.closest('.item-card');

            if (draggedElement && dropTargetCard && draggedElement !== dropTargetCard) {
                const draggedId = draggedElement.dataset.itemId;
                const dropTargetId = dropTargetCard.dataset.itemId;

                const draggedIndex = currentOrder.findIndex(item => item.id === draggedId);
                const dropTargetIndex = currentOrder.findIndex(item => item.id === dropTargetId);

                if (draggedIndex > -1 && dropTargetIndex > -1) {
                    const [removed] = currentOrder.splice(draggedIndex, 1);
                    currentOrder.splice(dropTargetIndex, 0, removed);
                    renderItems();
                }
            }

            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            if (dragOverElement) {
                dragOverElement.classList.remove('drag-over');
            }
            draggedElement = null;
            dragOverElement = null;
        }

        // --- Keyboard Accessibility for Reordering ---
        function handleKeyboardDrag(e) {
            if (!gameActive) return;

            const card = e.target.closest('.item-card');
            if (!card) return;

            const currentId = card.dataset.itemId;
            const currentIndex = currentOrder.findIndex(item => item.id === currentId);

            let newIndex = currentIndex;

            if (e.key === 'ArrowUp') {
                e.preventDefault(); // Prevent scrolling
                newIndex = Math.max(0, currentIndex - 1);
            } else if (e.key === 'ArrowDown') {
                e.preventDefault(); // Prevent scrolling
                newIndex = Math.min(currentOrder.length - 1, currentIndex + 1);
            }

            if (newIndex !== currentIndex) {
                const [removed] = currentOrder.splice(currentIndex, 1);
                currentOrder.splice(newIndex, 0, removed);
                renderItems();
                // Re-focus the moved card to maintain accessibility
                const newCard = rankingArea.querySelector(`[data-item-id="${currentId}"]`);
                if (newCard) {
                    newCard.focus();
                }
            }
        }


        // --- Scoring and Results ---
        function checkRankings() {
            if (!gameActive && gameMode !== 'untimed') { // Allow checking in untimed mode even if game is technically "over"
                return;
            }
            gameActive = false; // End the game
            stopTimer(); // Stop the timer if running

            let totalScore = 0;
            let resultsHtml = '';
            let finalTimeMs = timeRemaining; // Capture time at the moment of checking

            currentOrder.forEach((item, index) => {
                const userRank = index + 1;
                const expertRank = item.expertRank;
                const difference = Math.abs(userRank - expertRank);
                totalScore += difference;
            });

            let assessment = '';
            let assessmentColor = '';
            if (totalScore <= SCORE_EXCELLENT) {
                assessment = 'EXCELLENT - NASA Astronaut Material!';
                assessmentColor = '#00ff88';
            } else if (totalScore <= SCORE_GOOD) {
                assessment = 'GOOD - You\'d likely survive!';
                assessmentColor = '#88ff00';
            } else if (totalScore <= SCORE_FAIR) {
                assessment = 'FAIR - Risky but possible';
                assessmentColor = '#ffaa00';
            } else {
                assessment = 'POOR - Survival unlikely';
                assessmentColor = '#ff4444';
            }

            resultsHtml += `
                <div class="score">
                    <div>SURVIVAL ASSESSMENT SCORE: ${totalScore}</div>
                    <div style="color: ${assessmentColor}; margin-top: 10px;">${assessment}</div>
                    <div style="font-size: 14px; color: #ccc; margin-top: 10px;">
                        (Lower scores indicate better survival chances)
                    </div>
            `;
            if (gameMode !== 'untimed') {
                const initialTimeMs = getInitialTime(gameMode) * 1000;
                const timeTakenMs = initialTimeMs - finalTimeMs;
                resultsHtml += `<div style="font-size: 18px; color: var(--nasa-white); margin-top: 15px;">Time Taken: ${formatTime(timeTakenMs, true)}</div>`;
            }
            resultsHtml += `</div>`;

            resultsHtml += `
                <div class="expert-explanation">
                    <strong>How NASA Scoring Works:</strong> Your score is the sum of differences between your rankings and NASA expert rankings.
                    Perfect score = 0. The experts prioritized life support (oxygen, water, food) first, then communication and navigation,
                    then tools for the journey. Items useless on the Moon (matches, compass) ranked lowest.
                </div>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Your Rank</th>
                            <th>Expert Rank</th>
                            <th>Difference</th>
                            <th>Expert Reasoning</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const sortedItemsByExpertRank = [...items].sort((a, b) => a.expertRank - b.expertRank);

            sortedItemsByExpertRank.forEach(item => {
                const userRank = currentOrder.findIndex(i => i.id === item.id) + 1;
                const expertRank = item.expertRank;
                const difference = Math.abs(userRank - expertRank);
                const diffColor = difference === 0 ? '#00ff88' : difference <= 2 ? '#ffaa00' : '#ff6666';

                resultsHtml += `
                    <tr>
                        <td><strong>${item.name}</strong></td>
                        <td style="text-align: center;">${userRank}</td>
                        <td style="text-align: center; color: #88ccff;">${expertRank}</td>
                        <td style="text-align: center; color: ${diffColor};">${difference > 0 ? '+' : ''}${difference}</td>
                        <td style="font-size: 11px;">${item.explanation}</td>
                    </tr>
                `;
            });

            resultsHtml += `
                    </tbody>
                </table>
                <div class="expert-explanation">
                    <strong>Key Insights:</strong><br>
                    • <strong>Oxygen</strong> is #1 - you'll die in minutes without it<br>
                    • <strong>Water</strong> is #2 - critical for multi-day survival<br>
                    • <strong>Food</strong> is #3 - needed for energy during the 50-mile trek<br>
                    • <strong>Communication</strong> is #4 - rescue teams need to find you<br>
                    • <strong>Navigation</strong> is #6 - you must know where you're going<br>
                    • <strong>Matches & Compass</strong> are useless - no oxygen to burn, no magnetic field
                </div>
            `;

            if (resultsDiv) {
                resultsDiv.innerHTML = resultsHtml;
                resultsDiv.classList.add('show');
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            }

            // High Score Logic for timed modes
            if (gameMode !== 'untimed') {
                const initialTimeMs = getInitialTime(gameMode) * 1000;
                const timeTakenMs = initialTimeMs - finalTimeMs;
                // Only add to high score if score is good enough (e.g., totalScore < 70)
                // For this game, lower time is better, so we use timeTakenMs directly.
                promptForInitials(gameMode, timeTakenMs);
            }
        }

        // --- Difficulty and Timer Functions ---
        function setDifficulty(mode) {
            gameMode = mode;
            difficultyButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`difficulty${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');

            stopTimer();
            if (gameMode === 'untimed') {
                timerDisplay.textContent = '00:00';
                timerDisplay.style.color = 'var(--nasa-white)'; // Reset color for untimed
                gameActive = true; // Always active in untimed
                checkBtn.disabled = false;
            } else {
                timeRemaining = getInitialTime(gameMode) * 1000; // Convert seconds to milliseconds
                updateTimerDisplay();
                gameActive = true; // Start active for timed modes
                checkBtn.disabled = false;
                startTimer();
            }
            displayHighScores(gameMode); // Update high score list for selected mode
        }

        function getInitialTime(mode) {
            switch (mode) {
                case '1min': return 60; // seconds
                case '3min': return 180;
                case '5min': return 300;
                default: return 0; // untimed
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval); // Clear any existing timer
            startTime = Date.now(); // Record start time for accurate time taken calculation
            timerInterval = setInterval(() => {
                if (!gameActive) { // Timer should stop if game is no longer active (e.g., submitted or time ran out)
                    stopTimer();
                    return;
                }
                const elapsed = Date.now() - startTime;
                const initialTimeMs = getInitialTime(gameMode) * 1000;
                timeRemaining = initialTimeMs - elapsed;

                if (timeRemaining <= 0) {
                    timeRemaining = 0;
                    updateTimerDisplay();
                    stopTimer();
                    gameActive = false; // Game over
                    alert("Time's up! Your survival strategy will now be analyzed.");
                    checkRankings(); // Automatically check rankings when time runs out
                    checkBtn.disabled = true; // Disable button after time runs out
                }
                updateTimerDisplay();
            }, 100); // Update every 100ms for smoother countdown
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(timeRemaining, false); // Pass false for countdown format
            if (timeRemaining <= 10000 && gameMode !== 'untimed') { // Less than 10 seconds, turn red
                timerDisplay.style.color = 'var(--nasa-red-accent)';
            } else {
                timerDisplay.style.color = 'var(--nasa-white)'; // Reset to white for other times
            }
        }

        function formatTime(ms, isTimeTaken = false) {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((ms % 1000) / 100); // First digit of milliseconds

            if (isTimeTaken) { // Format for time taken (MM:SS.X)
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${milliseconds}`;
            } else { // Format for countdown (MM:SS.X)
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${milliseconds}`;
            }
        }

        // --- High Score Logic ---
        function loadHighScores() {
            try {
                const storedScores = localStorage.getItem(HIGH_SCORES_KEY);
                if (storedScores) {
                    highScores = JSON.parse(storedScores);
                }
            } catch (e) {
                console.error("Error loading high scores from localStorage:", e);
                // Reset highScores to default empty if parsing fails
                highScores = { '1min': [], '3min': [], '5min': [] };
            }
        }

        function saveHighScores() {
            try {
                localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(highScores));
            } catch (e) {
                console.error("Error saving high scores to localStorage:", e);
            }
        }

        function displayHighScores(mode) {
            if (!highScoresContainer || !highScoreList || !highScoreTitle) return;

            highScoreTitle.textContent = `Best Times (${mode === 'untimed' ? 'Untimed' : mode.toUpperCase()})`;
            highScoreList.innerHTML = '';

            const scoresForMode = highScores[mode] || [];

            // Sort by time (ascending)
            scoresForMode.sort((a, b) => a.timeMs - b.timeMs);

            if (scoresForMode.length === 0) {
                highScoreList.innerHTML = '<li>No scores yet. Be the first!</li>';
            } else {
                scoresForMode.slice(0, 10).forEach(score => { // Display top 10
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${score.initials}</span> <span>${formatTime(score.timeMs, true)}</span>`;
                    highScoreList.appendChild(li);
                });
            }
            highScoresContainer.classList.add('show'); // Always show high scores for the selected mode
        }

        function promptForInitials(mode, timeMs) {
            if (initialsModal && initialsInput) {
                initialsModal.style.display = 'flex';
                initialsInput.value = '';
                initialsInput.focus();

                // Handle Enter key to submit initials
                initialsInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        submitInitials(); // Call submitInitials without args, it will read from dataset
                    }
                };
                // Store mode and timeMs for submitInitials
                initialsModal.dataset.mode = mode;
                initialsModal.dataset.timeMs = timeMs;
            }
        }

        function submitInitials() {
            const mode = initialsModal.dataset.mode;
            const timeMs = parseInt(initialsModal.dataset.timeMs, 10);
            const initials = initialsInput.value.trim().toUpperCase();

            if (initials.length === 3 && /^[A-Z]{3}$/.test(initials)) {
                if (!highScores[mode]) {
                    highScores[mode] = [];
                }
                highScores[mode].push({ initials, timeMs });
                saveHighScores();
                displayHighScores(mode);
                initialsModal.style.display = 'none';
            } else {
                alert("Please enter exactly three uppercase letters for your initials.");
            }
        }

        // --- Game Reset ---
        function resetGame() {
            initGame(); // Re-initialize the game (shuffles and re-renders)
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
        }

        // --- Event Listeners for Difficulty Buttons ---
        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const mode = button.id.replace('difficulty', '').toLowerCase();
                setDifficulty(mode);
            });
        });

        // --- Initial Setup on DOM Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            // Show cookie notice if not dismissed
            if (!localStorage.getItem('cookieNoticeDismissed')) {
                if (cookieNotice) cookieNotice.style.display = 'block';
            }
            // Add event listener to cookie notice button
            if (cookieNotice) {
                cookieNotice.querySelector('button').addEventListener('click', () => {
                    localStorage.setItem('cookieNoticeDismissed', 'true');
                });
            }
        });
    </script>
</body>
</html>